<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compositionality Interactive — Page 4</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body data-prev="page3.html" data-next="page5.html">
  <div class="app">
    <div class="top">
      <h1>The same logic can be expressed more clearly</h1>
      <p>
        Both programs below produce the same result. Click highlighted areas to see how each part corresponds.
      </p>
    </div>

    <div class="ribbon" aria-label="Concept ribbon">
      <div class="step"><span class="chip" id="chipData">Data</span><span class="arrow">→</span></div>
      <div class="step"><span class="chip" id="chipFilter">Filter</span><span class="arrow">→</span></div>
      <div class="step"><span class="chip" id="chipMap">Map</span><span class="arrow">→</span></div>
      <div class="step"><span class="chip" id="chipSum">Sum</span><span class="arrow">→</span></div>
      <div class="step"><span class="chip" id="chipResult">Result</span></div>
      <div class="pill" id="stagePill" style="margin-left:10px;">Click a highlight</div>
    </div>

    <div class="main cols-2-wide">
      <!-- Left: loop code -->
      <section class="panel" aria-label="Loop-based code">
        <div class="panel-header">
          <div class="title">Loop-based</div>
          <div class="pill">Antipattern shape</div>
        </div>
        <div class="panel-body">
          <div class="codebox" id="codeLeft">
            <div class="line" data-role="static"><span class="gutter">1</span><span class="content">nums = [1, 2, 3, 4, 5, 6]</span></div>
            <div class="line hl" data-map="data"   id="L_data"><span class="gutter">2</span><span class="content">total = 0</span></div>
            <div class="line hl" data-map="iter"   id="L_iter"><span class="gutter">3</span><span class="content">for x in nums:</span></div>
            <div class="line hl" data-map="filter" id="L_filter"><span class="gutter">4</span><span class="content">    if x % 2 == 0:</span></div>
            <div class="line hl" data-map="map"    id="L_map"><span class="gutter">5</span><span class="content">        y = x * x</span></div>
            <div class="line hl" data-map="sum"    id="L_sum"><span class="gutter">6</span><span class="content">        total += y</span></div>
            <div class="line hl" data-map="result" id="L_result"><span class="gutter">7</span><span class="content">print(total)</span></div>
          </div>

          <div class="intermediate" id="midLeft"></div>
        </div>
      </section>

      <!-- Right: compositional code -->
      <section class="panel" aria-label="Compositional code">
        <div class="panel-header">
          <div class="title">Compositional</div>
          <div class="pill">map + filter + sum</div>
        </div>
        <div class="panel-body">
          <div class="codebox" id="codeRight">
            <div class="line" data-role="static"><span class="gutter">1</span><span class="content">def is_even(x): return x % 2 == 0</span></div>
            <div class="line" data-role="static"><span class="gutter">2</span><span class="content">def square(x): return x * x</span></div>
            <div class="line hl" data-map="data"   id="R_data"><span class="gutter">3</span><span class="content">nums = [1, 2, 3, 4, 5, 6]</span></div>
            <div class="line hl" data-map="sum"    id="R_sum"><span class="gutter">4</span><span class="content">result = sum(</span></div>
            <div class="line hl" data-map="map"    id="R_map"><span class="gutter">5</span><span class="content">    map(square,</span></div>
            <div class="line hl" data-map="filter" id="R_filter"><span class="gutter">6</span><span class="content">        filter(is_even, nums)</span></div>
            <div class="line hl" data-map="sum"    id="R_sum2"><span class="gutter">7</span><span class="content">    )</span></div>
            <div class="line hl" data-map="sum"    id="R_sum3"><span class="gutter">8</span><span class="content">)</span></div>
            <div class="line hl" data-map="result" id="R_result"><span class="gutter">9</span><span class="content">print(result)</span></div>
          </div>

          <div class="intermediate" id="midRight"></div>

          <div class="footer-row">
            <div class="toggle">
              <div class="switch" id="toggleMid" aria-label="Show intermediate values toggle" role="switch" aria-checked="false">
                <div class="knob"></div>
              </div>
              <span>Show intermediate values</span>
            </div>
            <div class="pill">Result should be 56</div>
          </div>

          <div class="explain" id="explain">
            Click a highlighted area to see how the two versions correspond.
          </div>
        </div>
      </section>
    </div>

    <div class="bottom">
      <div class="btnrow">
        <button id="backBtn">◀ Back</button>
      </div>
      <div class="btnrow">
        <button id="nextBtn" class="btn-next">Next ▶</button>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

<script src="assets/nav.js"></script>
<script>
  const toastEl = document.getElementById("toast");
  const stagePill = document.getElementById("stagePill");
  const explainEl = document.getElementById("explain");
  const toggleMid = document.getElementById("toggleMid");
  const midLeft = document.getElementById("midLeft");
  const midRight = document.getElementById("midRight");

  const chips = {
    Data: document.getElementById("chipData"),
    Filter: document.getElementById("chipFilter"),
    Map: document.getElementById("chipMap"),
    Sum: document.getElementById("chipSum"),
    Result: document.getElementById("chipResult")
  };

  const ALL_HL = Array.from(document.querySelectorAll(".hl"));

  const EXPLAINS = {
    data: {
      stage: "Data",
      pill: "Data",
      text: "Both programs start with the same input data."
    },
    iter: {
      stage: "Data",
      pill: "Iteration",
      text: "The loop iterates over the data. In the compositional version, the pipeline starts from the same data source."
    },
    filter: {
      stage: "Filter",
      pill: "Filter",
      text: "Filtering decides which values are included. In the compositional version, that logic is separated and reusable."
    },
    map: {
      stage: "Map",
      pill: "Map",
      text: "Mapping transforms each value independently. The transformation is explicit and isolated."
    },
    sum: {
      stage: "Sum",
      pill: "Sum",
      text: "Aggregation combines values into a single result."
    },
    result: {
      stage: "Result",
      pill: "Result",
      text: "Both programs produce the same final output — they differ in how clearly the steps are separated."
    }
  };

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    window.clearTimeout(showToast._t);
    showToast._t = window.setTimeout(()=>toastEl.classList.remove("show"), 2000);
  }

  function clearActive(){
    ALL_HL.forEach(el=>el.classList.remove("active"));
  }

  function setRibbon(stage){
    Object.values(chips).forEach(ch=>ch.classList.remove("active"));
    // always show Data as present when anything selected
    chips.Data.classList.add("active");

    if(stage === "Filter") chips.Filter.classList.add("active");
    if(stage === "Map") chips.Map.classList.add("active");
    if(stage === "Sum") chips.Sum.classList.add("active");
    if(stage === "Result") chips.Result.classList.add("active");
  }

  function activate(mapKey){
    clearActive();

    // Highlight all lines in both code blocks that share mapKey
    ALL_HL.filter(el => el.dataset.map === mapKey).forEach(el=>el.classList.add("active"));

    const info = EXPLAINS[mapKey];
    stagePill.textContent = info ? info.pill : "—";
    explainEl.textContent = info ? info.text : "—";
    setRibbon(info ? info.stage : null);
  }

  // Attach click handlers
  ALL_HL.forEach(el=>{
    el.addEventListener("click", ()=>{
      activate(el.dataset.map);
    });
  });

  // Intermediate values toggle
  const nums = [1,2,3,4,5,6];
  const evens = nums.filter(x=>x%2===0);
  const squares = evens.map(x=>x*x);
  const total = squares.reduce((a,b)=>a+b,0);

  function renderIntermediate(){
    const text =
`After filter:
[${evens.join(", ")}]

After map:
[${squares.join(", ")}]

After sum:
${total}`;
    midLeft.textContent = text;
    midRight.textContent = text;
  }
  renderIntermediate();

  function setIntermediateVisible(on){
    toggleMid.classList.toggle("on", on);
    toggleMid.setAttribute("aria-checked", on ? "true" : "false");
    midLeft.style.display = on ? "block" : "none";
    midRight.style.display = on ? "block" : "none";
    if(on){
      showToast("Intermediate values shown.");
    } else {
      showToast("Intermediate values hidden.");
    }
  }

  let midOn = false;
  toggleMid.addEventListener("click", ()=>{
    midOn = !midOn;
    setIntermediateVisible(midOn);
  });

  // Initial state
  setRibbon(null);
</script>
</body>
</html>
