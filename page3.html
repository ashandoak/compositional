<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compositionality Interactive — Page 3</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body data-page="3" data-prev="page2.html" data-next="page4.html">
  <div class="app">
    <div class="top">
      <h1>Functional primitives</h1>
      <p>
        Combine general-purpose operations with small functions. Drag an array, a primitive, and (if needed) a function into the workspace.
      </p>
    </div>

    <div class="main page3-grid">
      <div class="page3-spacer" aria-hidden="true"></div>

      <!-- Center: hero workspace -->
      <section class="panel page3-hero" aria-label="Interactive workspace">
        <!-- (kept for structure, hidden by CSS on page 3) -->
        <div class="panel-header">
          <div class="title">Workspace</div>
          <div class="pill">Build a pipeline</div>
        </div>

        <!-- PANEL BODY: interactive area ONLY -->
        <div class="panel-body">
          <div class="workspace page3-workspace" id="workspace" aria-label="Workspace surface">
            <div class="ws-row">
              <div class="slot" id="slotArray">
                <div class="slot-label">Array</div>
                <div class="slot-body">
                  <span class="placeholder">Drop an array here</span>
                </div>
              </div>
            </div>

            <div class="ws-row">
              <div class="slot" id="slotPrimitive">
                <div class="slot-label">Primitive</div>
                <div class="slot-body">
                  <span class="placeholder">Drop a primitive here</span>
                </div>
              </div>

              <div class="slot" id="slotFunction">
                <div class="slot-label">Function (optional)</div>
                <div class="slot-body">
                  <span class="placeholder">Drop a predicate/transform here (if needed)</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PANEL FOOTER: terminal is OUTSIDE panel-body -->
        <div class="panel-footer page3-terminal">
          <div class="terminal" aria-label="Python preview and output">
            <div class="term-title">
              <div class="label">Python (preview & output)</div>
              <div class="muted">simulated</div>
            </div>

            <pre id="preview"># Drag an array + a primitive + (if needed) a function</pre>
            <div class="term-sep"></div>
            <pre id="result" class="muted">Output:
—</pre>
            <pre id="hint" class="muted" style="margin-top:10px; display:none;"></pre>
          </div>
        </div>
      </section>

      <!-- Right: toolbox -->
      <section class="panel page3-bank" aria-label="Toolbox">
        <div class="panel-header">
          <div class="title">Toolbox</div>
          <div class="pill">Drag items</div>
        </div>

        <div class="panel-body">
          <div class="group-title">Arrays</div>

          <div class="draggable" draggable="true" data-type="array" data-id="a1">
            <span>nums = [1, 2, 3, 4, 5, 6]</span>
          </div>
          <div class="draggable" draggable="true" data-type="array" data-id="a2">
            <span>nums = [0, 1, 2, 3, 4]</span>
          </div>
          <div class="draggable" draggable="true" data-type="array" data-id="a3">
            <span>nums = [-3, -2, -1, 0, 1, 2]</span>
          </div>

          <div style="height:14px;"></div>

          <div class="group-title">Primitives</div>

          <div class="draggable" draggable="true" data-type="primitive" data-id="filter">
            <span>filter( predicate, data )</span>
          </div>
          <div class="draggable" draggable="true" data-type="primitive" data-id="map">
            <span>map( transform, data )</span>
          </div>
          <div class="draggable" draggable="true" data-type="primitive" data-id="sum">
            <span>sum( data )</span>
          </div>

          <div style="height:14px;"></div>

          <div class="group-title">Functions</div>

          <div class="bank-subhead">Predicates (✔/✖)</div>

          <div class="draggable" draggable="true" data-type="fn" data-kind="predicate" data-id="is_even">
            <span>is_even(x)</span>
          </div>
          <div class="draggable" draggable="true" data-type="fn" data-kind="predicate" data-id="is_positive">
            <span>is_positive(x)</span>
          </div>
          <div class="draggable" draggable="true" data-type="fn" data-kind="predicate" data-id="greater_than_2">
            <span>greater_than_2(x)</span>
          </div>

          <div style="height:14px;"></div>

          <div class="bank-subhead">Transforms (→)</div>

          <div class="draggable" draggable="true" data-type="fn" data-kind="transform" data-id="square">
            <span>square(x)</span>
          </div>
          <div class="draggable" draggable="true" data-type="fn" data-kind="transform" data-id="double">
            <span>double(x)</span>
          </div>
          <div class="draggable" draggable="true" data-type="fn" data-kind="transform" data-id="negate">
            <span>negate(x)</span>
          </div>

          <!-- Keep the element if your JS references it, but hide via CSS -->
          <div class="hint" id="rightHint" style="margin-top:12px;"></div>
        </div>
      </section>
    </div>

    <div class="bottom">
      <div class="btnrow">
        <button id="backBtn">◀ Back</button>
        <button id="resetBtn" class="btn-primary">Reset</button>
      </div>
      <div class="btnrow">
        <button id="nextBtn" class="btn-next">Next ▶</button>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script src="assets/nav.js"></script>
  <script>
    // ---- Data model ----
    const ARRAYS = {
      a1: [1,2,3,4,5,6],
      a2: [0,1,2,3,4],
      a3: [-3,-2,-1,0,1,2]
    };

    const FUNCTIONS = {
      // predicates
      is_even: { kind: "predicate", label: "is_even", apply: (x) => x % 2 === 0 },
      is_positive: { kind: "predicate", label: "is_positive", apply: (x) => x > 0 },
      greater_than_2: { kind: "predicate", label: "greater_than_2", apply: (x) => x > 2 },
      // transforms
      square: { kind: "transform", label: "square", apply: (x) => x * x },
      double: { kind: "transform", label: "double", apply: (x) => x * 2 },
      negate: { kind: "transform", label: "negate", apply: (x) => -x }
    };

    const PRIMITIVES = {
      filter: {
        label: "filter",
        needsFunction: true,
        accepts: "predicate",
        preview: (fnLabel, numsText) => `nums = ${numsText}\nresult = list(filter(${fnLabel}, nums))\nprint(result)`,
        explain: "filter keeps values that satisfy the predicate (True/False test).",
        eval: (arr, fn) => arr.filter(fn.apply)
      },
      map: {
        label: "map",
        needsFunction: true,
        accepts: "transform",
        preview: (fnLabel, numsText) => `nums = ${numsText}\nresult = list(map(${fnLabel}, nums))\nprint(result)`,
        explain: "map transforms every value independently.",
        eval: (arr, fn) => arr.map(fn.apply)
      },
      sum: {
        label: "sum",
        needsFunction: false,
        accepts: null,
        preview: (_fnLabel, numsText) => `nums = ${numsText}\nresult = sum(nums)\nprint(result)`,
        explain: "sum combines all numeric values into a single result.",
        eval: (arr) => arr.reduce((a,b) => a + b, 0)
      }
    };

    // ---- UI state ----
    let selectedArrayKey = null;
    let selectedPrimitive = null;
    let selectedFunction = null;

    // ---- DOM ----
    const toastEl = document.getElementById("toast");
    const workspaceEl = document.getElementById("workspace");

    const slotArrayEl = document.getElementById("slotArray");
    const slotPrimitiveEl = document.getElementById("slotPrimitive");
    const slotFunctionEl = document.getElementById("slotFunction");

    const previewEl = document.getElementById("preview");
    const resultEl = document.getElementById("result");
    const hintEl = document.getElementById("hint");
    const rightHintEl = document.getElementById("rightHint");

    // ✅ Fail fast: if this triggers, you have missing/duplicated IDs
    if (!previewEl || !resultEl || !hintEl) {
      console.error("Terminal elements not found:", { previewEl, resultEl, hintEl });
      alert("Page 3 error: terminal elements (#preview/#result/#hint) not found. Check IDs and duplicates.");
    }

    // ---- Helpers ----
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(()=>toastEl.classList.remove("show"), 2000);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;",
        "'":"&#039;"
      }[c]));
    }

    function numsTextFor(key){
      const arr = ARRAYS[key] || [];
      return `[${arr.join(", ")}]`;
    }

    function clearWorkspaceStatus(){
      workspaceEl.classList.remove("good","warn","bad");
      hintEl.style.display = "none";
      hintEl.textContent = "";
      // keep visible so you can always see updates
      resultEl.style.display = "block";
      resultEl.textContent = "Output:\n—";
    }

    function setWorkspaceStatus(kind, msg){
      workspaceEl.classList.remove("good","warn","bad");
      workspaceEl.classList.add(kind);
      hintEl.style.display = "block";
      hintEl.textContent = msg;
    }

    function renderSlots(){
      // Array slot
      const arrayBody = slotArrayEl.querySelector(".slot-body");
      arrayBody.innerHTML = selectedArrayKey
        ? `<span>${escapeHtml(`nums = ${numsTextFor(selectedArrayKey)}`)}</span>`
        : `<span class="placeholder">Drop an array here</span>`;
      setLocked(slotArrayEl, !!selectedArrayKey);

      // Primitive slot
      const primBody = slotPrimitiveEl.querySelector(".slot-body");
      primBody.innerHTML = selectedPrimitive
        ? `<span>${escapeHtml(displayPrimitiveText(selectedPrimitive))}</span>`
        : `<span class="placeholder">Drop a primitive here</span>`;
      setLocked(slotPrimitiveEl, !!selectedPrimitive);

      // Function slot
      const fnBody = slotFunctionEl.querySelector(".slot-body");
      if (!selectedPrimitive){
        fnBody.innerHTML = `<span class="placeholder">Drop a predicate/transform here (if needed)</span>`;
        setLocked(slotFunctionEl, false);
      } else {
        const prim = PRIMITIVES[selectedPrimitive];
        if (!prim.needsFunction){
          fnBody.innerHTML = `<span class="placeholder">(not needed for sum)</span>`;
          setLocked(slotFunctionEl, true);
        } else if (selectedFunction){
          fnBody.innerHTML = `<span>${escapeHtml(displayFnText(selectedFunction))}</span>`;
          setLocked(slotFunctionEl, true);
        } else {
          fnBody.innerHTML = `<span class="placeholder">Drop a ${prim.accepts} here</span>`;
          setLocked(slotFunctionEl, false);
        }
      }

      renderPreviewAndEval();

      function setLocked(slotEl, isLocked){
        slotEl.classList.toggle("locked", !!isLocked);
      }
    }

    function displayPrimitiveText(pid){
      if (pid === "filter") return "filter( predicate, data )";
      if (pid === "map") return "map( transform, data )";
      if (pid === "sum") return "sum( data )";
      return pid;
    }

    function displayFnText(fid){
      const f = FUNCTIONS[fid];
      if (!f) return fid;
      return `${f.label}(x)`;
    }

    function invalidHint(primLabel){
      if (primLabel === "filter") return "filter needs a function that returns True/False (a predicate).";
      if (primLabel === "map") return "map needs a function that returns a value (a transform).";
      return "That function doesn't fit this primitive.";
    }

    function formatOut(out){
      if (Array.isArray(out)) return `[${out.join(", ")}]`;
      return String(out);
    }

    function renderPreviewAndEval(){
      clearWorkspaceStatus();

      // Need at least array + primitive
      if (!selectedArrayKey || !selectedPrimitive){
        previewEl.textContent = "# Drag an array + a primitive + (if needed) a function";
        return;
      }

      const prim = PRIMITIVES[selectedPrimitive];
      const numsText = numsTextFor(selectedArrayKey);

      // Need a compatible function if required
      if (prim.needsFunction && !selectedFunction){
        previewEl.textContent = `nums = ${numsText}\n# Add a ${prim.accepts} to complete this call`;
        setWorkspaceStatus("warn", `Tip: ${prim.label} needs a ${prim.accepts}.`);
        return;
      }

      if (prim.needsFunction && selectedFunction){
        const fn = FUNCTIONS[selectedFunction];
        if (!fn || fn.kind !== prim.accepts){
          previewEl.textContent = `nums = ${numsText}\n# That function doesn't fit here`;
          setWorkspaceStatus("warn", invalidHint(prim.label));
          return;
        }
      }

      // Preview
      const fnLabel = selectedFunction ? FUNCTIONS[selectedFunction].label : null;
      previewEl.textContent = prim.preview(fnLabel, numsText);

      // Evaluate
      const arr = ARRAYS[selectedArrayKey];
      const out = prim.needsFunction ? prim.eval(arr, FUNCTIONS[selectedFunction]) : prim.eval(arr);

      resultEl.style.display = "block";
      resultEl.textContent = `Result:\n${formatOut(out)}\n\n${prim.explain}`;
      workspaceEl.classList.add("good");
    }

    function resetAll(){
      selectedArrayKey = null;
      selectedPrimitive = null;
      selectedFunction = null;
      renderSlots();
      showToast("Reset.");
    }

    // ---- Drag & drop ----
    function attachDraggables(){
      document.querySelectorAll(".draggable").forEach(el=>{
        el.addEventListener("dragstart", (e)=>{
          el.classList.add("dragging");
          const payload = {
            type: el.dataset.type,
            id: el.dataset.id,
            kind: el.dataset.kind || null
          };
          e.dataTransfer.setData("text/plain", JSON.stringify(payload));
          e.dataTransfer.effectAllowed = "move";
        });
        el.addEventListener("dragend", ()=>el.classList.remove("dragging"));
      });
    }

    function allowDrop(el){
      el.addEventListener("dragover", (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });
    }

    function handleDropOnSlot(slotKind){
      return (e)=>{
        e.preventDefault();
        const raw = e.dataTransfer.getData("text/plain");
        if (!raw) return;

        let payload;
        try { payload = JSON.parse(raw); } catch { return; }

        if (slotKind === "array"){
          if (payload.type !== "array"){
            showToast("Drop an array here.");
            return;
          }
          selectedArrayKey = payload.id;
          renderSlots();
          showToast("Array set.");
          return;
        }

        if (slotKind === "primitive"){
          if (payload.type !== "primitive"){
            showToast("Drop a primitive here.");
            return;
          }
          selectedPrimitive = payload.id;
          selectedFunction = null; // avoid stale mismatch
          renderSlots();
          showToast("Primitive set.");
          return;
        }

        if (slotKind === "function"){
          if (payload.type !== "fn"){
            showToast("Drop a function here.");
            return;
          }
          if (!selectedPrimitive){
            setWorkspaceStatus("warn", "Pick a primitive first.");
            showToast("Choose a primitive first.");
            return;
          }

          const prim = PRIMITIVES[selectedPrimitive];

          if (!prim.needsFunction){
            setWorkspaceStatus("warn", "sum doesn’t take a function.");
            showToast("sum doesn’t take a function.");
            return;
          }

          const fn = FUNCTIONS[payload.id];
          if (!fn || fn.kind !== prim.accepts){
            setWorkspaceStatus("warn", invalidHint(prim.label));
            showToast("That function doesn’t fit.");
            return;
          }

          selectedFunction = payload.id;
          renderSlots();
          showToast("Function set.");
        }
      };
    }

    // ---- Setup ----
    document.getElementById("resetBtn").addEventListener("click", resetAll);

    allowDrop(slotArrayEl);
    allowDrop(slotPrimitiveEl);
    allowDrop(slotFunctionEl);

    slotArrayEl.addEventListener("drop", handleDropOnSlot("array"));
    slotPrimitiveEl.addEventListener("drop", handleDropOnSlot("primitive"));
    slotFunctionEl.addEventListener("drop", handleDropOnSlot("function"));

    attachDraggables();
    renderSlots();

    // Don't show the "Try..." hint on page 3 (keep node to avoid nulls)
    if (rightHintEl) rightHintEl.style.display = "none";
  </script>
</body>
</html>
